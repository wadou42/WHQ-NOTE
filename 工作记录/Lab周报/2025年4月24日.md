### SCANN介绍
scann简介：SCANN​​（Scalable Nearest Neighbors）是一种​大规模向量相似度搜索算法​，属于​**​近似最近邻搜索​**​的范畴。

**​核心目标​**​：在超大规模数据集（如数十亿个向量）中快速找到与查询向量最相似的Top-K个向量。暴力搜索能找到全部的TOP-K，但速度极慢，因此近似邻近搜索算法就通过舍弃一定的准确度，来提高搜索速度。

关键指标：
**召回率**：找到的 / 总的
**QPS**： 每秒查询次数

下图中每一个点对应一个不同的查询参数，三条线对应三个不同的数据集。横坐标是召回率，纵坐标是查询速度——QPS
![[7948cabfb9879f863f4764fb77d41b8.png]]

1. 召回率越低速度越快，数据规模越小速度越快
2. 召回率大于80% 才比较有使用价值

### 测试指标问题
SOW给的测试指标包括三个数据集，如果全部测试，大概需要20+h，精简了一下
![[hw给的测试指标.png]]

所以我现在采用的是从 50 +个查询参数中，筛选出4个，他们的召回率分散在0.8 - 1之间。分别计算四个参数下opt对于-O3的加速比，再对加速比求均值，**作为指标**。
![[Scann查询参数.png]]

### SRTuenr & Random测量结果
* SRTuenr 共30轮，只有一轮优于-O3 ，是**1.012**
* Random 共30轮，其中四轮优于-O3，最好的结果是**1.030**

![[SRTuner_RandomTuenr.png]]

### 我们的方法
橙色线左侧是预测得到的TOP-10，然后进行**实测**得到的结果。其中有两个异常值，重复测试仍然是这么高，查看日志发现是因为回归率几乎为零导致的，应该是有些优化配置会破坏算法的正确性。排除这两个异常值之后，最大值是**1.0212**。
![[Autotunning.png]]

和SRTuner50轮对比，可以看到我们的方法提供了一个相对来说比较好的起点，只有一个性能明显低于-O3，其余加速比都在0.9以上。但是效果也并不理想，只有一个超过-O3，两个接近-O3。（我们后续的搜索策略也采用的Random搜索）
![[AutotunningVSSRTuner.png]]

### 指标参数的影响
大部分情况下，四个参数下的查询得到的加速比是接近的：
```text
flags / base = 119.49395953240338 / 124.12102978825011 = 0.9627213030399402
flags / base = 430.13271709100974 / 451.1873348128667 = 0.9533350870086158
flags / base = 199.15858604689714 / 206.26822934105576 = 0.9655320486491251
flags / base = 286.62968869529294 / 299.4451147754725 = 0.957202754535539
```
但是也有一些会有这种情况, 在某些查询参数下是优于-O3，某些查询参数下低于-O3（那对于ann-benchmark提供的所有查询参数呢？是否会平均下来大于-O3）：
```text
flags / base = 109.62593345179255 / 124.12102978825011 = 0.8832180464407512
flags / base = 514.5673657818438 / 451.1873348128667 = 1.140473869895449
flags / base = 198.40039755157784 / 206.26822934105576 = 0.9618563080964408
flags / base = 317.4198737511201 / 299.4451147754725 = 1.060026890033338
```













### 后续打算
现在模型的输入还是从数据集中提取的OPT，数量只有1.4k，数量较少，可能本身超越-O3的优化配置就比较少； 现在模型的预测准确度也相对来说比较低，尤其是对于未见过的OPT来说。

因此下一步打算回到模型这部分，先扩充一下数据集
check一下数据集是否有偏